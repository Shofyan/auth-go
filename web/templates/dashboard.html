{{define "content"}}
<div class="navbar">
    <h2>Auth Service Dashboard</h2>
    <nav>
        <a href="/web/dashboard">Dashboard</a>
        <a href="/web/profile">Profile</a>
        <button onclick="logout()">
            Logout
        </button>
    </nav>
</div>

<h1>Welcome to Dashboard</h1>
<p>You are successfully authenticated!</p>

<div id="profile-data">
    <p>Loading your profile...</p>
</div>

<div style="margin-top: 30px;">
    <h2 style="margin-bottom: 15px;">Quick Actions</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">View Profile</h3>
            <a href="/web/profile" style="color: #667eea; text-decoration: none;">Go to Profile â†’</a>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">Refresh Token</h3>
            <button onclick="refreshToken()" 
                    style="width: auto; padding: 8px 16px; font-size: 14px; margin-top: 10px;">
                Refresh
            </button>
        </div>
    </div>
</div>

<div id="message" style="margin-top: 20px;"></div>

<script>
    // Check if user is authenticated
    const token = localStorage.getItem('accessToken');
    if (!token) {
        window.location.href = '/web/login';
    }

    // Load profile data
    async function loadProfile() {
        try {
            const response = await fetch('/web/profile-data', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
            
            if (response.ok) {
                const html = await response.text();
                document.getElementById('profile-data').innerHTML = html;
            } else if (response.status === 401) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/web/login';
            } else {
                document.getElementById('profile-data').innerHTML = 
                    '<div class="error">Failed to load profile</div>';
            }
        } catch (error) {
            document.getElementById('profile-data').innerHTML = 
                '<div class="error">Network error</div>';
        }
    }

    // Refresh token
    async function refreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            window.location.href = '/web/login';
            return;
        }

        try {
            const response = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            
            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                document.getElementById('message').innerHTML = 
                    '<div class="success">Token refreshed successfully!</div>';
                setTimeout(() => {
                    document.getElementById('message').innerHTML = '';
                }, 3000);
            } else {
                document.getElementById('message').innerHTML = 
                    '<div class="error">Token refresh failed</div>';
            }
        } catch (error) {
            document.getElementById('message').innerHTML = 
                '<div class="error">Network error</div>';
        }
    }

    // Logout
    async function logout() {
        try {
            await fetch('/api/v1/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/web/login';
    }

    // Load profile on page load
    loadProfile();
</script>
{{end}}
