{{define "content"}}
<div class="navbar">
    <h2>üîê Auth Service Dashboard</h2>
    <nav>
        <a href="/">üè† Home</a>
        <a href="/web/dashboard" style="font-weight: bold; border-bottom: 2px solid white;">Dashboard</a>
        <a href="/web/profile">Profile</a>
        <button onclick="logout()">
            Logout
        </button>
    </nav>
</div>

<h1>Welcome to Dashboard</h1>
<p>You are successfully authenticated!</p>

<!-- Admin Panel for User Management -->
<div id="admin-panel" style="display: none; margin-top: 30px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0;">
        <h2 style="margin: 0;">üë• Admin User Management</h2>
    </div>
    <div style="background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="üîç Search users by email..." 
                   style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px;"
                   onkeyup="searchUsers()">
        </div>
        
        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #666; font-size: 14px;">
                <span id="user-count">0</span> users found
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-size: 14px; color: #666;">Items per page:</label>
                <select id="itemsPerPage" onchange="updatePagination()" 
                        style="padding: 6px 10px; border: 2px solid #e1e8ed; border-radius: 4px; font-size: 14px;">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
        
        <div id="user-list">
            <p style="color: #666;">Loading users...</p>
        </div>
        
        <div id="pagination" style="margin-top: 20px; display: none;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                <button onclick="changePage(-1)" id="prevBtn" 
                        style="width: auto; padding: 8px 16px; font-size: 14px; background: #667eea; border: none; color: white; border-radius: 4px; cursor: pointer;">
                    ‚Üê Previous
                </button>
                
                <div id="pageNumbers" style="display: flex; gap: 5px; align-items: center;">
                    <!-- Page numbers will be inserted here -->
                </div>
                
                <button onclick="changePage(1)" id="nextBtn" 
                        style="width: auto; padding: 8px 16px; font-size: 14px; background: #667eea; border: none; color: white; border-radius: 4px; cursor: pointer;">
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>
</div>



<div style="margin-top: 30px;">
    <h2 style="margin-bottom: 15px;">Quick Actions</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">View Profile</h3>
            <a href="/web/profile" style="color: #667eea; text-decoration: none;">Go to Profile ‚Üí</a>
        </div>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="font-size: 16px; margin-bottom: 10px;">Refresh Token</h3>
            <button onclick="refreshToken()" 
                    style="width: auto; padding: 8px 16px; font-size: 14px; margin-top: 10px;">
                Refresh
            </button>
        </div>
    </div>
</div>

<div id="message" style="margin-top: 20px;"></div>

<script>
    // Check if user is authenticated
    const token = localStorage.getItem('accessToken');
    if (!token) {
        window.location.href = '/web/login';
    }

    // Load profile data
    // async function loadProfile() {
    //     try {
    //         const response = await fetch('/web/profile-data', {
    //             headers: {
    //                 'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
    //             }
    //         });
            
    //         if (response.ok) {
    //             const html = await response.text();
    //             document.getElementById('profile-data').innerHTML = html;
    //         } else if (response.status === 401) {
    //             localStorage.removeItem('accessToken');
    //             localStorage.removeItem('refreshToken');
    //             window.location.href = '/web/login';
    //         } else {
    //             document.getElementById('profile-data').innerHTML = 
    //                 '<div class="error">Failed to load profile</div>';
    //         }
    //     } catch (error) {
    //         document.getElementById('profile-data').innerHTML = 
    //             '<div class="error">Network error</div>';
    //     }
    // }

    // Refresh token
    async function refreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            window.location.href = '/web/login';
            return;
        }

        try {
            const response = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            
            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                document.getElementById('message').innerHTML = 
                    '<div class="success">Token refreshed successfully!</div>';
                setTimeout(() => {
                    document.getElementById('message').innerHTML = '';
                }, 3000);
            } else {
                document.getElementById('message').innerHTML = 
                    '<div class="error">Token refresh failed</div>';
            }
        } catch (error) {
            document.getElementById('message').innerHTML = 
                '<div class="error">Network error</div>';
        }
    }

    // Logout
    async function logout() {
        try {
            await fetch('/api/v1/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/web/login';
    }

    // Pagination variables
    let allUsers = [];
    let filteredUsers = [];
    let currentPage = 1;
    let itemsPerPage = 10;

    // Check if user is admin and load users
    async function checkAdminAndLoadUsers() {
        try {
            const response = await fetch('/api/v1/auth/profile', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                // Show admin panel
                document.getElementById('admin-panel').style.display = 'block';
                
                // Wait for users to load completely
                await loadAllUsers();
            }
        } catch (error) {
            console.error('Error checking admin status:', error);
        }
    }

    // Load all users (admin only)
    async function loadAllUsers() {
        try {
            const response = await fetch('/api/v1/admin/users', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                }
            });
            
            if (response.ok) {
                allUsers = await response.json();
                filteredUsers = [...allUsers];
                updatePagination();
                // Wait for DOM to update
                await new Promise(resolve => setTimeout(resolve, 0));
            } else {
                document.getElementById('user-list').innerHTML = 
                    '<p style="color: #e53e3e;">‚ùå Failed to load users</p>';
            }
        } catch (error) {
            document.getElementById('user-list').innerHTML = 
                '<p style="color: #e53e3e;">‚ùå Error loading users</p>';
        }
    }
    
    // Initialize page: load admin users first, then profile
    async function initializePage() {
        await checkAdminAndLoadUsers();
      // await loadProfile();
    }

    // Load profile on page load
    initializePage();

    // Update pagination and display
    function updatePagination() {
        itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
        currentPage = 1;
        displayCurrentPage();
    }

    // Display current page
    function displayCurrentPage() {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageUsers = filteredUsers.slice(startIndex, endIndex);

        displayUsersTable(pageUsers);
        updatePaginationControls(totalPages);
        document.getElementById('user-count').textContent = filteredUsers.length;
    }

    // Display users in table
    function displayUsersTable(users) {
        if (!users || users.length === 0) {
            document.getElementById('user-list').innerHTML = '<p style="color: #666;">No users found</p>';
            document.getElementById('pagination').style.display = 'none';
            return;
        }

        let html = `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Email</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Roles</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Status</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #4a5568;">Created</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
        `;

        users.forEach(user => {
            const statusColor = user.is_active ? '#48bb78' : '#e53e3e';
            const statusText = user.is_active ? 'Active' : 'Inactive';
            const createdDate = new Date(user.created_at).toLocaleDateString();
            
            html += `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px; color: #2d3748;">${user.email}</td>
                    <td style="padding: 12px;">`;
            
            user.roles.forEach(role => {
                html += `<span class="badge" style="margin-right: 4px;">${role}</span>`;
            });
            
            html += `</td>
                    <td style="padding: 12px;">
                        <span style="color: ${statusColor}; font-weight: bold; padding: 4px 8px; background: ${statusColor}20; border-radius: 12px; font-size: 12px;">
                            ${statusText}
                        </span>
                    </td>
                    <td style="padding: 12px; color: #718096;">${createdDate}</td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        document.getElementById('user-list').innerHTML = html;
    }

    // Update pagination controls
    function updatePaginationControls(totalPages) {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        
        prevBtn.style.opacity = currentPage === 1 ? '0.5' : '1';
        prevBtn.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
        nextBtn.style.opacity = (currentPage === totalPages || totalPages === 0) ? '0.5' : '1';
        nextBtn.style.cursor = (currentPage === totalPages || totalPages === 0) ? 'not-allowed' : 'pointer';
        
        // Generate page numbers
        const pageNumbersContainer = document.getElementById('pageNumbers');
        pageNumbersContainer.innerHTML = '';
        
        if (totalPages <= 7) {
            // Show all pages if 7 or fewer
            for (let i = 1; i <= totalPages; i++) {
                pageNumbersContainer.appendChild(createPageButton(i));
            }
        } else {
            // Show first page
            pageNumbersContainer.appendChild(createPageButton(1));
            
            if (currentPage > 3) {
                pageNumbersContainer.appendChild(createEllipsis());
            }
            
            // Show pages around current page
            let startPage = Math.max(2, currentPage - 1);
            let endPage = Math.min(totalPages - 1, currentPage + 1);
            
            for (let i = startPage; i <= endPage; i++) {
                pageNumbersContainer.appendChild(createPageButton(i));
            }
            
            if (currentPage < totalPages - 2) {
                pageNumbersContainer.appendChild(createEllipsis());
            }
            
            // Show last page
            if (totalPages > 1) {
                pageNumbersContainer.appendChild(createPageButton(totalPages));
            }
        }
        
        document.getElementById('pagination').style.display = totalPages > 1 ? 'block' : 'none';
    }
    
    // Create page button
    function createPageButton(pageNum) {
        const button = document.createElement('button');
        button.textContent = pageNum;
        button.onclick = () => goToPage(pageNum);
        
        const isActive = pageNum === currentPage;
        button.style.cssText = `
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid ${isActive ? '#667eea' : '#e2e8f0'};
            background: ${isActive ? '#667eea' : 'white'};
            color: ${isActive ? 'white' : '#4a5568'};
            border-radius: 4px;
            cursor: pointer;
            font-weight: ${isActive ? 'bold' : 'normal'};
            transition: all 0.2s;
        `;
        
        if (!isActive) {
            button.onmouseenter = () => {
                button.style.background = '#f7fafc';
                button.style.borderColor = '#667eea';
            };
            button.onmouseleave = () => {
                button.style.background = 'white';
                button.style.borderColor = '#e2e8f0';
            };
        }
        
        return button;
    }
    
    // Create ellipsis
    function createEllipsis() {
        const span = document.createElement('span');
        span.textContent = '...';
        span.style.cssText = 'padding: 6px 8px; color: #a0aec0; font-size: 14px;';
        return span;
    }
    
    // Go to specific page
    function goToPage(pageNum) {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        if (pageNum >= 1 && pageNum <= totalPages) {
            currentPage = pageNum;
            displayCurrentPage();
        }
    }

    // Change page
    function changePage(direction) {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayCurrentPage();
        }
    }

    // Search/filter users
    function searchUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (searchTerm === '') {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm)
            );
        }
        
        currentPage = 1;
        displayCurrentPage();
    }
</script>
{{end}}
